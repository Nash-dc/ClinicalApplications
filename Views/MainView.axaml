<UserControl
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:vm="using:ClinicalApplications.ViewModels"
    x:Class="ClinicalApplications.Views.MainView"
    x:DataType="vm:MainViewViewModel">

  <Grid Margin="16" RowDefinitions="Auto,*">

    <Expander Grid.Row="0"
              IsExpanded="True"
              Header="Actions"
              Padding="12"
              Margin="0,0,0,12">
      <Grid ColumnDefinitions="Auto,*,Auto"
            RowDefinitions="Auto">

        <Button Grid.Row="0" Grid.Column="0"
                Content="Upload Patient CSV"
                Click="OnUploadCsvClicked"
                HorizontalAlignment="Left"/>

        <Button Grid.Row="0" Grid.Column="2"
                Content="Send"
                Command="{Binding SendRequestCommand}"
                HorizontalAlignment="Right"/>
      </Grid>
    </Expander>

    <Grid Grid.Row="1" ColumnDefinitions="2*,1.2*">

      <ScrollViewer Grid.Column="0" VerticalScrollBarVisibility="Auto">
        <StackPanel Spacing="12">

          <Border CornerRadius="8" Padding="8" BorderThickness="1">
            <DataGrid ItemsSource="{Binding PatientDisplay}"
                      IsReadOnly="True"
                      AutoGenerateColumns="False"
                      HeadersVisibility="Column"
                      CanUserReorderColumns="False"
                      CanUserResizeColumns="True"
                      CanUserSortColumns="False"
                      MinHeight="140" MaxHeight="260">
              <DataGrid.Columns>
                <DataGridTemplateColumn Header="Field" Width="2*">
                  <DataGridTemplateColumn.CellTemplate>
                    <DataTemplate>
                      <TextBlock Text="{Binding Label}">
                        <ToolTip.Tip>
                          <TextBlock Text="{Binding Tooltip}" TextWrapping="Wrap" MaxWidth="360"/>
                        </ToolTip.Tip>
                      </TextBlock>
                    </DataTemplate>
                  </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
                <DataGridTextColumn Header="Value" Binding="{Binding Value}" Width="*"/>
              </DataGrid.Columns>
            </DataGrid>
          </Border>

          <Border CornerRadius="8" Padding="12" BorderThickness="1">
            <StackPanel Spacing="6">
              <TextBlock Text="Cardiotoxicity (CTRCD) Risk"
                         FontWeight="SemiBold"/>
              <TextBox Text="{Binding CtrcdSummary}"
                       IsReadOnly="True"
                       TextWrapping="Wrap"
                       MinHeight="40"
                       Watermark="No prediction yet"/>
              <TextBlock Text="{Binding CtrcdDetail}"
                         IsVisible="{Binding IsCtrcdDetailVisible}"
                         Opacity="0.85"
                         TextWrapping="Wrap"/>

              <TextBlock Text="ⓘ"
                         Foreground="Gray"
                         FontSize="12">
                <ToolTip.Tip>
                  <TextBlock Text="CTRCD: Cancer Therapy–Related Cardiac Dysfunction. Displaying probability/label and key drivers."
                             TextWrapping="Wrap" MaxWidth="360"/>
                </ToolTip.Tip>
              </TextBlock>
            </StackPanel>
          </Border>

        </StackPanel>
      </ScrollViewer>



      <ScrollViewer Grid.Column="1" VerticalScrollBarVisibility="Auto">
        <StackPanel Spacing="12">

          <Border CornerRadius="12" Padding="12" BorderThickness="0" Background="#F0F6FF">
            <StackPanel Spacing="8">
              <TextBlock Text="AI Weekly Exercise Plan" FontWeight="Bold" FontSize="14"/>
              <TextBlock Text="{Binding NoPlanText}"
                         IsVisible="{Binding NoPlan}"
                         Foreground="#7A7A7A"/>

              <ItemsControl ItemsSource="{Binding PlanWeek}" IsVisible="{Binding HasPlan}">
                <ItemsControl.Styles>
                  <Style Selector="Border.tag">
                    <Setter Property="Background" Value="#E6F0FF"/>
                    <Setter Property="CornerRadius" Value="6"/>
                    <Setter Property="Padding" Value="4,2"/>
                    <Setter Property="Margin" Value="0,0,6,0"/>
                  </Style>
                </ItemsControl.Styles>
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Border Margin="0,4" CornerRadius="8" Background="White" BorderBrush="#D9E6FF" BorderThickness="1">
                      <Grid ColumnDefinitions="Auto,*,Auto,Auto,Auto" Margin="10">
                        <TextBlock Grid.Column="0" Text="{Binding day}" FontWeight="SemiBold" Margin="0,0,10,0"/>
                        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                          <Border Classes="tag">
                            <TextBlock Text="{Binding steps, StringFormat=Steps: {0}}"/>
                          </Border>
                          <Border Classes="tag">
                            <TextBlock Text="{Binding active_minutes, StringFormat=Active: {0} min}"/>
                          </Border>
                          <Border Classes="tag">
                            <TextBlock Text="{Binding rpe, StringFormat=RPE: {0}}"/>
                          </Border>
                        </StackPanel>
                      </Grid>
                    </Border>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </StackPanel>
          </Border>

          <Border CornerRadius="12" Padding="12" BorderThickness="0" Background="#FFF9EE">

            <StackPanel Spacing="8">
              <TextBlock Text="Safety Notes" FontWeight="Bold" FontSize="14"/>
              <ItemsControl ItemsSource="{Binding SafetyNotes}" IsVisible="{Binding HasPlan}">
                <ItemsControl.ItemsPanel>
                  <ItemsPanelTemplate>
                    <WrapPanel/>
                  </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Border Background="#FFEED6" CornerRadius="999" Padding="8,4" Margin="0,6,6,0" BorderBrush="#FFD7A8" BorderThickness="1">
                      <TextBlock Text="{Binding}"/>
                    </Border>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </StackPanel>
          </Border>


          <Border CornerRadius="10" Padding="10" BorderThickness="1" BorderBrush="#FFB8B8" Background="#FFF0F0">
            <StackPanel Orientation="Horizontal" Spacing="8">
              <TextBlock Text="⚠" FontSize="16" VerticalAlignment="Center"/>
              <TextBlock Text="{Binding PauseRule}" TextWrapping="Wrap"/>
            </StackPanel>
          </Border>

          <TextBlock Text="{Binding StatusMessage}" Opacity="0.9"/>
        </StackPanel>
      </ScrollViewer>


    </Grid>
  </Grid>
</UserControl>
